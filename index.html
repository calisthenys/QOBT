<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>QOBT - Lista de Obreiros</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #001f3f; color: white; }
  .text-gold { color: #D4AF37; }
  .bg-gold { background-color: #D4AF37; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  input::placeholder { color: rgba(255, 255, 255, 0.4); }
</style>
</head>
<body class="h-full overflow-hidden">

<div id="app" class="h-full w-full flex flex-col overflow-hidden">
  <header class="bg-[#001f3f] border-b border-gold/20 text-white px-4 py-6 shadow-lg flex-shrink-0 z-20">
    <div class="max-w-lg mx-auto flex justify-between items-center">
      <a href="https://ktap558.github.io/" class="text-gold text-xs font-bold flex items-center">
        <i class="fas fa-chevron-left mr-2"></i> VOLTAR
      </a>
      <div class="text-center">
        <h1 class="text-lg font-800 tracking-tighter text-gold uppercase leading-tight">Lista de<br>Obreiros</h1>
      </div>
      <div class="w-10"></div> 
    </div>
  </header>

  <main class="flex-1 overflow-auto scrollbar-hide">
    <section id="public-view" class="h-full flex flex-col">
      <div class="px-6 py-4 sticky top-0 z-10 bg-[#001f3f]/90 backdrop-blur-md">
        <div class="relative">
            <i class="fas fa-search absolute left-4 top-3.5 text-gold/50 text-sm"></i>
            <input type="text" id="search-input" placeholder="Buscar por nome, cargo ou campo..." 
            class="w-full pl-12 pr-4 py-3 bg-white/5 rounded-2xl text-sm outline-none border border-gold/20 focus:border-gold text-white">
        </div>
        <p id="member-count" class="text-[9px] text-gold/60 mt-3 text-center font-bold uppercase tracking-[2px]"></p>
      </div>

      <div id="members-list" class="flex-1 px-6 py-2">
          <div class="max-w-lg mx-auto space-y-4"></div>
      </div>
    </section>

    <section id="login-view" class="hidden h-full flex items-center justify-center px-6">
      <div class="bg-white/5 w-full max-w-xs p-8 rounded-[2rem] border border-gold/20 text-center backdrop-blur-sm">
        <i class="fas fa-user-shield text-gold text-3xl mb-4"></i>
        <h2 class="font-bold mb-6 uppercase text-xs tracking-widest text-gold">Secretaria</h2>
        <input id="admin-password" type="password" placeholder="SENHA ADM" class="w-full px-4 py-4 bg-white/10 rounded-xl text-center mb-4 outline-none border border-gold/10 text-white">
        <button id="login-btn" class="w-full bg-gold text-[#001f3f] py-4 rounded-xl font-900 uppercase tracking-tighter shadow-lg">Acessar</button>
        <button onclick="showView('public')" class="w-full text-white/40 text-[10px] mt-6 uppercase font-bold">Voltar</button>
      </div>
    </section>

    <section id="admin-view" class="hidden h-full flex flex-col bg-[#001226]">
      <div class="px-6 py-4 border-b border-gold/10 flex justify-between items-center bg-[#001f3f]">
        <span class="font-bold text-[10px] uppercase text-gold tracking-widest">Painel Obreiros</span>
        <div class="flex gap-3">
            <button onclick="openAddForm()" class="bg-gold text-[#001f3f] px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-tighter">+ NOVO</button>
            <button onclick="isAdmin=false;showView('public')" class="text-[10px] bg-red-500/20 text-red-500 border border-red-500/50 px-3 py-2 rounded-lg font-bold uppercase">Sair</button>
        </div>
      </div>
      <div class="flex-1 overflow-auto p-6">
        <div id="admin-members-list" class="max-w-lg mx-auto space-y-3"></div>
      </div>
    </section>

    <section id="form-view" class="hidden h-full bg-[#001f3f] flex flex-col p-6 overflow-auto">
       <div class="flex justify-between items-center mb-8">
           <button onclick="showView('admin')" class="text-white/50 font-bold text-xs uppercase">Cancelar</button>
           <button id="save-form-btn" class="bg-gold text-[#001f3f] px-8 py-3 rounded-xl font-900 uppercase text-xs">Salvar</button>
       </div>
       <div class="space-y-6">
          <div class="text-center">
            <div id="photo-preview" class="w-32 h-32 bg-white/5 rounded-full mx-auto flex items-center justify-center overflow-hidden border-2 border-dashed border-gold/30 text-gold shadow-2xl">+</div>
            <input type="file" id="photo-input" accept="image/*" class="hidden">
            <button onclick="$('photo-input').click()" class="text-gold text-[10px] mt-4 font-bold uppercase tracking-widest bg-gold/10 px-4 py-2 rounded-full">Carregar Foto</button>
          </div>
          <div class="space-y-4">
              <input id="input-nome" type="text" placeholder="Nome Completo" class="w-full p-4 bg-white/5 border border-gold/10 rounded-2xl outline-none focus:border-gold text-white uppercase">
              
              <select id="input-cargo" class="w-full p-4 bg-white/10 border border-gold/20 rounded-2xl text-gold outline-none">
                <option value="Pastor">Pastor</option>
                <option value="Evangelista">Evangelista</option>
                <option value="Presbítero">Presbítero</option>
                <option value="Diácono">Diácono</option>
                <option value="Missionária">Missionária</option>
              </select>
              
              <input id="input-campo" type="text" placeholder="Campo / Setor / Congregação" class="w-full p-4 bg-white/5 border border-gold/10 rounded-2xl outline-none focus:border-gold text-white uppercase">
              
              <input id="input-conjuge" type="text" placeholder="Nome do Cônjuge" class="w-full p-4 bg-white/5 border border-gold/10 rounded-2xl outline-none focus:border-gold text-white uppercase">
          </div>
       </div>
    </section>

    <section id="profile-view" class="hidden h-full bg-[#001f3f] flex flex-col"></section>
  </main>
  
  <footer class="bg-[#001f3f] p-6 border-t border-gold/10 text-center">
      <button id="admin-link" class="text-gold/40 text-[9px] font-bold uppercase tracking-[4px]">Acesso Administrativo</button>
  </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
const ADMIN_PASS = "IGREJA2026";

const firebaseConfig = {
  apiKey:"AIzaSyCTfWEzEhm1EwgV5rXHeyYobyCj5HODrGA",
  authDomain:"qobt-d795a.firebaseapp.com",
  projectId:"qobt-d795a",
  storageBucket:"qobt-d795a.appspot.com",
  messagingSenderId:"403676737812",
  appId:"1:403676737812:web:8074bf2c1df2b234129201"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let members = [];
let isAdmin = false;
let photoBase64 = "";
let editingId = null;
const $ = (id) => document.getElementById(id);

function startApp() {
  db.collection("obreiro").onSnapshot(snap => {
    const raw = snap.docs.map(d => ({id: d.id, ...d.data()}));
    const ordem = {"Pastor": 1, "Evangelista": 2, "Presbítero": 3, "Diácono": 4, "Missionária": 5};
    members = raw.sort((a, b) => {
      const pA = ordem[a.cargo] || 99;
      const pB = ordem[b.cargo] || 99;
      return pA !== pB ? pA - pB : a.nome.localeCompare(b.nome);
    });
    renderPublicList($("search-input").value);
    renderAdminList();
  });
}

window.onload = startApp;

function showView(v){ ["public","login","admin","form","profile"].forEach(s => $(`${s}-view`).classList.add("hidden")); $(`${v}-view`).classList.remove("hidden"); }
$("admin-link").onclick = () => showView(isAdmin ? "admin" : "login");
$("login-btn").onclick = () => { if($("admin-password").value.toUpperCase() === ADMIN_PASS) { isAdmin=true; showView("admin"); } else alert("Senha incorreta!"); };

function renderPublicList(q="") {
  const container = $("members-list").querySelector("div");
  const filtered = members.filter(m => m.nome.toLowerCase().includes(q.toLowerCase()) || m.cargo.toLowerCase().includes(q.toLowerCase()) || (m.campo && m.campo.toLowerCase().includes(q.toLowerCase())));
  container.innerHTML = filtered.map(m => `
    <div onclick="showProfile('${m.id}')" class="bg-white/5 p-5 rounded-2xl border border-gold/10 flex items-center gap-4 active:scale-95 transition-all shadow-xl">
      ${m.foto ? `<img src="${m.foto}" class="w-14 h-14 rounded-full object-cover border-2 border-gold/30 shadow-lg">` : `<div class="w-14 h-14 bg-gold/10 rounded-full flex items-center justify-center text-gold text-lg font-black border border-gold/20">${m.nome[0]}</div>`}
      <div>
        <p class="font-bold text-white text-sm uppercase tracking-tight">${m.nome}</p>
        <p class="text-[9px] text-gold font-bold uppercase tracking-widest mt-1 opacity-70">${m.cargo} • ${m.campo || 'SEDE'}</p>
      </div>
      <i class="fas fa-chevron-right ml-auto text-gold/20 text-xs"></i>
    </div>
  `).join("");
  $("member-count").textContent = filtered.length + " Obreiros Cadastrados";
}

function showProfile(id) {
  const m = members.find(x => x.id === id);
  $("profile-view").innerHTML = `
    <div class="p-6 flex items-center border-b border-gold/10">
        <button onclick="showView('public')" class="text-gold text-sm font-bold"><i class="fas fa-chevron-left mr-2"></i> VOLTAR</button>
    </div>
    <div class="flex-1 overflow-auto">
      <div class="p-10 text-center">
        ${m.foto ? `<img src="${m.foto}" class="w-40 h-40 rounded-full mx-auto shadow-[0_0_30px_rgba(212,175,55,0.2)] border-4 border-gold/20 object-cover">` : `<div class="w-40 h-40 bg-gold/10 mx-auto rounded-full flex items-center justify-center text-gold text-5xl font-black border border-gold/20">${m.nome[0]}</div>`}
        <h2 class="text-2xl font-800 mt-6 text-white uppercase tracking-tighter leading-tight">${m.nome}</h2>
        <div class="bg-gold text-[#001f3f] px-6 py-2 rounded-full inline-block text-[10px] mt-4 uppercase font-black tracking-widest shadow-lg">${m.cargo}</div>
      </div>
      <div class="px-8 space-y-4 pb-12">
        <div class="bg-white/5 p-6 rounded-3xl border border-gold/10 text-center">
            <p class="text-[9px] text-gold/50 font-black uppercase tracking-[3px] mb-2">Congregação / Campo</p>
            <p class="font-bold text-white text-lg">${m.campo || 'SEDE'}</p>
        </div>
        <div class="bg-white/5 p-6 rounded-3xl border border-gold/10 text-center">
            <p class="text-[9px] text-gold/50 font-black uppercase tracking-[3px] mb-2">Cônjuge</p>
            <p class="font-bold text-white text-lg">${m.conjuge || '---'}</p>
        </div>
      </div>
    </div>`;
  showView("profile");
}

function openAddForm() {
    editingId = null;
    $("input-nome").value = ""; $("input-campo").value = ""; $("input-conjuge").value = "";
    photoBase64 = ""; $("photo-preview").innerHTML = "+";
    showView('form');
}

window.editMember = (id) => {
  const m = members.find(x => x.id === id); editingId = id;
  $("input-nome").value = m.nome; $("input-cargo").value = m.cargo;
  $("input-campo").value = m.campo || ""; $("input-conjuge").value = m.conjuge || "";
  photoBase64 = m.foto || ""; $("photo-preview").innerHTML = photoBase64 ? `<img src="${photoBase64}" class="w-full h-full object-cover">` : "+";
  showView("form");
};

$("save-form-btn").onclick = async () => {
  const data = { 
    nome: $("input-nome").value.toUpperCase(), 
    cargo: $("input-cargo").value, 
    campo: $("input-campo").value.toUpperCase(), 
    conjuge: $("input-conjuge").value.toUpperCase(), 
    foto: photoBase64 
  };
  if(!data.nome) return alert("Digite o nome!");
  $("save-form-btn").innerText = "SALVANDO...";
  if(editingId) await db.collection("obreiro").doc(editingId).update(data);
  else await db.collection("obreiro").add(data);
  $("save-form-btn").innerText = "SALVAR";
  showView("admin");
};

function renderAdminList() {
  $("admin-members-list").innerHTML = members.map(m => `
    <div class="bg-white/5 p-4 rounded-xl border border-gold/10 flex justify-between items-center shadow-lg">
      <div class="flex flex-col">
          <span class="text-[11px] font-bold text-white uppercase">${m.nome.split(' ')[0]}...</span>
          <span class="text-[9px] text-gold/50 font-bold uppercase">${m.cargo}</span>
      </div>
      <div class="flex gap-1">
          <button onclick="editMember('${m.id}')" class="p-3 text-gold/60"><i class="fas fa-edit"></i></button>
          <button onclick="deleteMember('${m.id}')" class="p-3 text-red-400/60"><i class="fas fa-trash-alt"></i></button>
      </div>
    </div>
  `).join("");
}

window.deleteMember = async (id) => { if(confirm("Apagar permanentemente?")) await db.collection("obreiro").doc(id).delete(); };

$("photo-input").onchange = (e) => {
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      let width = 400; let scale = width / img.width;
      canvas.width = width; canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      photoBase64 = canvas.toDataURL("image/jpeg", 0.7);
      $("photo-preview").innerHTML = `<img src="${photoBase64}" class="w-full h-full object-cover">`;
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(e.target.files[0]);
};

$("search-input").oninput = (e) => renderPublicList(e.target.value);
</script>
</body>
</html>
