<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QOBT - Quadro de Obreiros</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Inter',sans-serif;}
  .scrollbar-hide::-webkit-scrollbar{display:none}
  .scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none}
  .gate-gradient { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
</style>
</head>
<body class="bg-blue-50 h-full">

<div id="gatekeeper-view" class="fixed inset-0 gate-gradient z-[100] flex items-center justify-center px-4">
  <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Acesso Restrito</h2>
    <p class="text-gray-500 text-sm mb-6">Digite a chave de acesso da igreja para visualizar o Quadro de Obreiros.</p>
    <input id="gate-key" type="password" placeholder="Chave de Acesso" class="w-full px-4 py-3 bg-gray-100 border-2 border-transparent focus:border-blue-500 rounded-xl text-center font-bold tracking-widest outline-none mb-4 transition-all">
    <button id="unlock-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">Entrar</button>
    <p id="gate-error" class="hidden text-red-500 text-xs mt-3 font-medium">Chave de acesso incorreta!</p>
  </div>
</div>

<div id="app" class="hidden h-full w-full flex flex-col overflow-hidden">
  <header id="main-header" class="bg-blue-600 text-white px-4 py-4 shadow-lg flex-shrink-0 z-20">
    <div class="max-w-lg mx-auto flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold tracking-tight">QOBT</h1>
        <p class="text-blue-100 text-[10px] uppercase font-bold tracking-widest">Tapau√° - AM</p>
      </div>
      <button id="lock-app" class="bg-blue-500 p-2 rounded-lg hover:bg-blue-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
      </button>
    </div>
  </header>

  <main id="main-content" class="flex-1 overflow-auto scrollbar-hide">
    <section id="public-view" class="h-full flex flex-col">
      <div class="px-4 py-3 bg-white border-b sticky top-0 z-10">
        <div class="max-w-lg mx-auto">
          <input type="text" id="search-input" placeholder="Buscar obreiro..." class="w-full pl-4 pr-4 py-2.5 bg-gray-100 border border-transparent rounded-xl text-sm focus:bg-white focus:border-blue-200 outline-none transition-all">
          <p id="member-count" class="text-[10px] text-blue-500 mt-2 text-center font-bold uppercase tracking-wider"></p>
        </div>
      </div>
      <div id="members-list" class="flex-1 overflow-auto px-4 py-4"><div class="max-w-lg mx-auto space-y-3"></div></div>
    </section>

    <section id="login-view" class="hidden h-full flex items-center justify-center px-4 bg-gray-50">
      <div class="bg-white max-w-xs w-full p-6 rounded-3xl shadow-xl border">
        <h2 class="text-center font-bold text-gray-800 mb-4">√Årea Restrita ADM</h2>
        <input id="admin-password" type="password" placeholder="Senha ADM" class="w-full px-4 py-3 bg-gray-100 rounded-xl text-center tracking-widest mb-3 outline-none border-2 border-transparent focus:border-blue-600">
        <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md">Acessar Painel</button>
        <button onclick="showView('public')" class="w-full text-gray-400 text-sm mt-4">Voltar</button>
      </div>
    </section>

    <section id="admin-view" class="hidden h-full flex flex-col bg-gray-50">
      <div class="px-4 py-3 bg-gray-800 text-white flex justify-between items-center shadow-md">
        <span class="font-bold text-sm uppercase tracking-widest">Administra√ß√£o</span>
        <button id="logout-btn" class="text-xs bg-red-600 px-3 py-1.5 rounded-lg font-bold">SAIR</button>
      </div>
      <div class="flex-1 overflow-auto p-4">
        <div class="max-w-lg mx-auto space-y-4">
          <button id="add-member-btn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition-all uppercase tracking-wider">Cadastrar Novo Obreiro</button>
          <div id="admin-members-list" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <section id="form-view" class="hidden h-full bg-gray-100 flex flex-col">
      <div class="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-20">
        <button onclick="showView('admin')" class="text-blue-600 font-bold text-sm">CANCELAR</button>
        <h2 id="form-title" class="font-bold text-gray-800">CADASTRAR</h2>
        <button id="save-form-btn" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md">SALVAR</button>
      </div>
      <div class="flex-1 overflow-auto p-4 space-y-4">
        <div class="max-w-lg mx-auto space-y-4 pb-10">
          <div class="bg-white p-6 rounded-2xl shadow-sm text-center">
            <div id="photo-preview" class="w-24 h-24 bg-blue-50 rounded-full mx-auto mb-4 border-2 border-dashed border-blue-200 flex items-center justify-center overflow-hidden">+</div>
            <input type="file" id="photo-input" accept="image/*" class="hidden">
            <button onclick="$('photo-input').click()" class="text-blue-600 text-xs font-bold uppercase">Alterar Foto</button>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm space-y-4">
            <input id="input-nome" type="text" placeholder="Nome Completo" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 ring-blue-500">
            <select id="input-cargo" class="w-full p-3 bg-gray-50 rounded-xl border-none outline-none">
              <option value="">Selecione o Cargo</option>
              <option>Pastor</option><option>Evangelista</option><option>Presb√≠tero</option>
              <option>Di√°cono</option><option>Cooperador</option><option>Auxiliar</option>
            </select>
            <div class="flex gap-2">
              <label class="flex-1"><input type="radio" name="marital-status" value="casado" id="radio-casado" class="hidden peer"><div class="p-3 bg-gray-50 border-2 border-transparent rounded-xl text-center text-sm peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">Casado</div></label>
              <label class="flex-1"><input type="radio" name="marital-status" value="solteiro" id="radio-solteiro" checked class="hidden peer"><div class="p-3 bg-gray-50 border-2 border-transparent rounded-xl text-center text-sm peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">Solteiro</div></label>
            </div>
          </div>
          <div id="spouse-section" class="hidden bg-white p-4 rounded-2xl shadow-sm space-y-4 border-2 border-blue-100">
            <input id="input-conjuge" type="text" placeholder="Nome do C√¥njuge" class="w-full p-3 bg-gray-50 rounded-xl border-none">
            <input id="input-cargo-conjuge" type="text" placeholder="Cargo do C√¥njuge" class="w-full p-3 bg-gray-50 rounded-xl border-none">
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm space-y-4">
            <input id="input-setor" type="text" placeholder="Setor" class="w-full p-3 bg-gray-50 rounded-xl border-none">
            <input id="input-campo" type="text" placeholder="Campo" class="w-full p-3 bg-gray-50 rounded-xl border-none">
          </div>
        </div>
      </div>
    </section>
    <section id="profile-view" class="hidden h-full bg-white overflow-auto"></section>
  </main>

  <footer class="bg-white p-4 border-t text-center flex-shrink-0">
    <button id="admin-link" class="text-blue-600 text-[10px] font-bold uppercase tracking-[0.2em]">Painel Administrativo</button>
  </footer>
</div>

<div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-8 py-3 rounded-full text-xs font-bold shadow-2xl z-[200]"></div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
const CHURCH_KEY = "TAPAUA2026";
const ADMIN_PASS = "IGREJA2026";

const firebaseConfig = {
  apiKey:"AIzaSyCTfWEzEhm1EwgV5rXHeyYobyCj5HODrGA",
  authDomain:"qobt-d795a.firebaseapp.com",
  projectId:"qobt-d795a",
  storageBucket:"qobt-d795a.appspot.com",
  messagingSenderId:"403676737812",
  appId:"1:403676737812:web:8074bf2c1df2b234129201"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let members = [];
let isAdmin = false;
const $ = (id) => document.getElementById(id);

// --- FUN√á√ÉO DE AUTO-CADASTRO (IMPORTANTE) ---
async function checkAndSeedData() {
  const snapshot = await db.collection("obreiro").limit(1).get();
  if (snapshot.empty) {
    console.log("Banco vazio. Cadastrando obreiros iniciais...");
    const initialMembers = [
      { nome: "ADINO FILHO GOMES RODRIGUES", cargo: "Pastor", casado: true, conjuge: "ELDA DE SOUZA RODRIGUES", cargo_conjuge: "Mission√°ria" },
      { nome: "CALISTHENYS DE SOUZA RODRIGUES", cargo: "Pastor", casado: true, conjuge: "SHEYLA DE OLIVEIRA RODRIGUES", cargo_conjuge: "Mission√°ria" },
      { nome: "ALTAIR SOARES DA SILVA", cargo: "Pastor", casado: true, conjuge: "ELIANA BORGES DA SILVA", cargo_conjuge: "Mission√°ria" },
      { nome: "ARNALDO SABINO DE ARA√öJO", cargo: "Pastor", casado: true, conjuge: "ESTHER CHAVES DE ARA√öJO", cargo_conjuge: "Mission√°ria" },
      { nome: "DANIEL VIEIRA BATALHA", cargo: "Pastor", casado: true, conjuge: "LUCINEIA DOS SANTOS BATALHA", cargo_conjuge: "Mission√°ria" },
      { nome: "NATANAEL SOUZA BATISTA", cargo: "Pastor", casado: true, conjuge: "RAIMUNDA NONATA ALVINO DE SOUZA", cargo_conjuge: "Mission√°ria" },
      { nome: "RONILDO DOS SANTOS AUZIER", cargo: "Evangelista", casado: true, conjuge: "MISLANE DOS SANTOS COSTA AUZIER", cargo_conjuge: "Mission√°ria" },
      { nome: "ROBERTO DOS SANTOS CAMPOS", cargo: "Evangelista", casado: true, conjuge: "JUSLEY GAMA DE MOURA", cargo_conjuge: "Mission√°ria" },
      { nome: "ERLANE DE OLIVEIRA TAVARES", cargo: "Evangelista", casado: true, conjuge: "MARIA ILCICLEIDE CRAVEIRO GAMA", cargo_conjuge: "Mission√°ria" },
      { nome: "ADAIDO LIMA DE OLIVEIRA", cargo: "Evangelista", casado: true, conjuge: "MARIZETE TEIXEIRA DA MATA", cargo_conjuge: "Mission√°ria" },
      { nome: "GILBERTO COSTA VIEIRA", cargo: "Evangelista", casado: true, conjuge: "MARIA DOS SANTOS VIEIRA", cargo_conjuge: "Mission√°ria" },
      { nome: "LUIS CLAUDIO BARBOSA DE OLIVEIRA", cargo: "Evangelista", casado: true, conjuge: "MARIA APARECIDA BARBOSA DE OLIVEIRA", cargo_conjuge: "Mission√°ria" },
      { nome: "JEDSON PINHEIRO DUARTE", cargo: "Presb√≠tero", casado: true, conjuge: "FRANCISJANE SILVA BELEZA", cargo_conjuge: "Mission√°ria" },
      { nome: "ANTONIO TAVARES FERREIRA FILHO", cargo: "Presb√≠tero", casado: true, conjuge: "KARINA FIRMINO DA COSTA", cargo_conjuge: "Mission√°ria" },
      { nome: "ROBSON FONSECA TAVARES", cargo: "Presb√≠tero", casado: true, conjuge: "LUZINEIA GOMES TAVARES", cargo_conjuge: "Mission√°ria" },
      { nome: "MARCOS MICAIAS DE SOUZA RODRIGUES", cargo: "Di√°cono", casado: false },
      { nome: "SEBASTI√ÉO CORR√äA", cargo: "Di√°cono", casado: false },
      { nome: "ANTONIO CARLOS CARVALHO DE OLIVEIRA", cargo: "Di√°cono", casado: false },
      { nome: "EDVALDO ABILIO DA SILVA", cargo: "Di√°cono", casado: false }
    ];

    for (const m of initialMembers) {
      await db.collection("obreiro").add({
        ...m,
        setor: "Tapau√°",
        campo: "Sede",
        foto: "",
        foto_conjuge: ""
      });
    }
  }
}

// --- CONTROLE DE ACESSO ---
$("unlock-btn").onclick = async () => {
  if($("gate-key").value.toUpperCase() === CHURCH_KEY) {
    $("gatekeeper-view").classList.add("hidden");
    $("app").classList.remove("hidden");
    await checkAndSeedData(); // Tenta cadastrar se estiver vazio
    startApp();
  } else {
    $("gate-error").classList.remove("hidden");
    $("gate-key").value = "";
  }
};

$("lock-app").onclick = () => location.reload();

function startApp() {
  db.collection("obreiro").orderBy("nome").onSnapshot(snap => {
    members = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderPublicList($("search-input").value);
    renderAdminList();
  });
}

function showView(v){
  ["public","login","admin","form","profile"].forEach(s => $(`${s}-view`).classList.add("hidden"));
  $(`${v}-view`).classList.remove("hidden");
}

$("admin-link").onclick = () => showView(isAdmin ? "admin" : "login");
$("login-btn").onclick = () => {
  if($("admin-password").value.toUpperCase() === ADMIN_PASS) {
    isAdmin = true;
    showView("admin");
    $("admin-password").value = "";
  } else alert("Senha incorreta!");
};
$("logout-btn").onclick = () => { isAdmin=false; showView("public"); };

// --- LISTAGENS ---
function renderPublicList(q="") {
  const container = $("members-list").querySelector("div");
  const filtered = members.filter(m => m.nome.toLowerCase().includes(q.toLowerCase()));
  container.innerHTML = filtered.map(m => `
    <div onclick="showProfile('${m.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-blue-50 flex items-center gap-4 active:scale-95 transition-all">
      ${m.foto ? `<img src="${m.foto}" class="w-14 h-14 rounded-full object-cover">` : `<div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 font-bold">${m.nome[0]}</div>`}
      <div>
        <p class="font-bold text-gray-800 text-sm">${m.nome}</p>
        <p class="text-[10px] text-blue-600 font-bold uppercase tracking-widest">${m.cargo}</p>
      </div>
    </div>
  `).join("");
  $("member-count").textContent = filtered.length + " Obreiros Encontrados";
}

function renderAdminList() {
  $("admin-members-list").innerHTML = members.map(m => `
    <div class="bg-white p-3 rounded-xl border flex justify-between items-center">
      <span class="text-xs font-bold text-gray-700">${m.nome}</span>
      <div class="flex gap-2">
        <button onclick="editMember('${m.id}')">‚úèÔ∏è</button>
        <button onclick="deleteMember('${m.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join("");
}

function showProfile(id) {
  const m = members.find(x => x.id === id);
  $("profile-view").innerHTML = `
    <div class="bg-blue-600 text-white p-4 flex items-center gap-4 sticky top-0 z-10 shadow-md">
      <button onclick="showView('public')" class="text-xl">‚Üê</button>
      <span class="font-bold uppercase text-xs">Ficha de Obreiro</span>
    </div>
    <div class="p-8 text-center bg-gradient-to-b from-blue-50 to-white">
      ${m.foto ? `<img src="${m.foto}" class="w-32 h-32 rounded-full mx-auto border-4 border-white shadow-2xl object-cover">` : `<div class="w-32 h-32 bg-blue-100 rounded-full mx-auto flex items-center justify-center text-3xl font-bold text-blue-300">${m.nome[0]}</div>`}
      <h2 class="text-xl font-bold text-gray-800 mt-6 leading-tight">${m.nome}</h2>
      <div class="inline-block bg-blue-600 text-white px-6 py-1.5 rounded-full text-[10px] font-black uppercase mt-4 shadow-lg">${m.cargo}</div>
    </div>
    <div class="px-6 space-y-4 pb-10">
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-2xl text-center"><p class="text-[9px] font-black text-gray-400 uppercase">Setor</p><p class="font-bold text-gray-700">${m.setor || '---'}</p></div>
        <div class="bg-gray-50 p-4 rounded-2xl text-center"><p class="text-[9px] font-black text-gray-400 uppercase">Campo</p><p class="font-bold text-gray-700">${m.campo || '---'}</p></div>
      </div>
      ${m.casado ? `
        <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 mt-4">
          <p class="text-[9px] font-black text-blue-400 uppercase mb-4 tracking-widest">C√¥njuge</p>
          <div class="flex items-center gap-4">
             ${m.foto_conjuge ? `<img src="${m.foto_conjuge}" class="w-16 h-16 rounded-full object-cover">` : `<div class="w-16 h-16 bg-blue-100 rounded-full"></div>`}
             <div>
                <p class="font-bold text-gray-800 text-sm">${m.conjuge || "---"}</p>
                <p class="text-xs text-blue-600 font-bold uppercase">${m.cargo_conjuge || "Mission√°ria"}</p>
             </div>
          </div>
        </div>
      ` : ''}
    </div>
  `;
  showView("profile");
}

function toast(m) {
  $("toast").textContent = m;
  $("toast").classList.remove("hidden");
  setTimeout(() => $("toast").classList.add("hidden"), 2500);
}

$("search-input").oninput = (e) => renderPublicList(e.target.value);
window.showView = showView;
window.showProfile = showProfile;
</script>
</body>
</html>
