<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>QOBT - Quadro de Obreiros</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { font-family: Arial, sans-serif; }
.hidden { display: none !important; }
</style>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col">

<header class="bg-blue-600 text-white p-4 text-center shadow">
  <h1 class="text-xl font-bold">QOBT</h1>
  <p class="text-sm">Quadro de Obreiros Belemita de Tapauá</p>
</header>

<main class="flex-1 p-4">

  <!-- PUBLIC -->
  <section id="public-view">
    <input id="search-input" placeholder="Buscar obreiro..." class="w-full p-2 border rounded mb-4">
    <p id="member-count" class="text-xs mb-2"></p>
    <div id="members-list" class="space-y-2"></div>
    <p id="empty-state" class="text-center text-gray-500 hidden">Nenhum obreiro encontrado</p>
  </section>

  <!-- LOGIN -->
  <section id="login-view" class="hidden">
    <div class="max-w-xs mx-auto bg-white p-4 shadow rounded">
      <h2 class="font-semibold text-center mb-2">Área Administrativa</h2>
      <input id="admin-password" type="password"
             placeholder="Senha" class="w-full p-2 border rounded text-center">
      <p id="login-error" class="hidden text-red-500 text-xs mt-2 text-center">Senha incorreta</p>
      <button id="login-btn" class="w-full mt-3 bg-blue-600 text-white p-2 rounded">Entrar</button>
      <button id="back-from-login" class="w-full mt-2 text-blue-600 text-sm">← Voltar</button>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin-view" class="hidden">
    <button id="logout-btn" class="text-blue-600 mb-4">← Sair</button>
    <button id="add-member-btn" class="w-full bg-blue-600 text-white p-2 rounded mb-4">Cadastrar Obreiro</button>
    <div id="admin-members-list" class="space-y-2"></div>
    <p id="admin-empty-state" class="hidden text-gray-500 text-center">Nenhum obreiro cadastrado</p>
  </section>

  <!-- FORM -->
  <section id="form-view" class="hidden">
    <h2 id="form-title" class="font-semibold text-center mb-4">Novo Obreiro</h2>
    <input id="input-nome" placeholder="Nome" class="w-full p-2 border rounded mb-2">
    <input id="input-cargo" placeholder="Cargo" class="w-full p-2 border rounded mb-2">
    <input id="input-setor" placeholder="Setor" class="w-full p-2 border rounded mb-2">
    <input id="input-campo" placeholder="Campo" class="w-full p-2 border rounded mb-4">
    <button id="save-form-btn" class="w-full bg-blue-600 text-white p-2 rounded mb-2">Salvar</button>
    <button id="cancel-form-btn" class="w-full text-blue-600">Cancelar</button>
  </section>

</main>

<footer class="p-4 text-center text-sm">
  <p>Igreja Ministério Belém Tapauá</p>
  <button id="admin-link" class="mt-2 text-blue-600 underline">Área Administrativa</button>
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>

<script>
// CONFIG
firebase.initializeApp({
  apiKey:"AIzaSyCTfWEzEhm1EwgV5rXHeyYobyCj5HODrGA",
  authDomain:"qobt-d795a.firebaseapp.com",
  projectId:"qobt-d795a"
});
const db = firebase.firestore();

let members = [];
let editing = null;
let isAdmin = false;
const ADMIN_PASSWORD = "IGREJA2026";

const $ = id => document.getElementById(id);

// VIEW HANDLER
function show(v){ ["public","login","admin","form"].forEach(x => $(x+"-view").classList.add("hidden"));
$(v+"-view").classList.remove("hidden"); }

// LOAD DATA
db.collection("obreiro").orderBy("nome").onSnapshot(snap=>{
  members = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderPublic();
  renderAdmin();
});

// RENDER PUBLIC
function renderPublic(q=""){
  const list = $("members-list");
  const filtered = members.filter(m=>m.nome.toLowerCase().includes(q.toLowerCase()));
  list.innerHTML = filtered.map(m=>`<div class="p-2 bg-white rounded shadow">
    <p class="font-semibold">${m.nome}</p><p class="text-sm">${m.cargo}</p>
  </div>`).join("");
  $("empty-state").classList.toggle("hidden", filtered.length>0);
  $("member-count").innerText = `${filtered.length} encontrado(s)`;
}
$("search-input").oninput=e=>renderPublic(e.target.value);

// LOGIN
$("admin-link").onclick=()=>show(isAdmin?"admin":"login");
$("login-btn").onclick=()=>{
  if($("admin-password").value===ADMIN_PASSWORD){ isAdmin=true; show("admin"); }
  else $("login-error").classList.remove("hidden");
};
$("back-from-login").onclick=()=>show("public");
$("logout-btn").onclick=()=>{isAdmin=false;show("public")};

// ADMIN RENDER
function renderAdmin(){
  $("admin-empty-state").classList.toggle("hidden", members.length>0);
  $("admin-members-list").innerHTML = members.map(m=>`
    <div class="p-2 bg-white rounded shadow flex justify-between">
      <div><p class="font-semibold">${m.nome}</p><p class="text-xs">${m.cargo}</p></div>
      <div class="flex gap-2">
        <button onclick="edit('${m.id}')" class="text-blue-600">Editar</button>
        <button onclick="del('${m.id}')" class="text-red-600">Excluir</button>
      </div>
    </div>`).join("");
}

// NEW / EDIT
$("add-member-btn").onclick=()=>{
  editing=null;
  $("input-nome").value="";$("input-cargo").value="";
  $("input-setor").value="";$("input-campo").value="";
  $("form-title").innerText="Novo Obreiro";
  show("form");
};
$("cancel-form-btn").onclick=()=>show("admin");
$("save-form-btn").onclick=async()=>{
  const o={
    nome:$("input-nome").value.trim(),
    cargo:$("input-cargo").value.trim(),
    setor:$("input-setor").value.trim(),
    campo:$("input-campo").value.trim()
  };
  if(!o.nome||!o.cargo) return alert("Preencha Nome e Cargo");
  editing ? await db.collection("obreiro").doc(editing).update(o)
          : await db.collection("obreiro").add(o);
  show("admin");
};
window.edit=id=>{
  const o=members.find(x=>x.id===id);
  editing=id;
  $("input-nome").value=o.nome;
  $("input-cargo").value=o.cargo;
  $("input-setor").value=o.setor||"";
  $("input-campo").value=o.campo||"";
  $("form-title").innerText="Editar Obreiro";
  show("form");
};
window.del=id=>db.collection("obreiro").doc(id).delete();
</script>
</body>
</html>
